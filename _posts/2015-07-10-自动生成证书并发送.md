---
layout: post
title: 自动生成证书并发送给用户
---

###{{ page.title }}

最近公司网站开启全站https加证书认证，所有访问网站的用户都需要为他生成证书，并且证书有效期仅为一年，
所以需要经常给公司员工开通证书，并且需要在证书到期之前通知员工知道，所以就写了一个脚本来每天刷一遍，
将快要到期的证书重新生成。脚本还有很多不完善的地方，后续在继续修改。

~~~python
#-*- coding: UTF-8 -*-
import datetime
import os
from email.Header import Header
from email.MIMEText import MIMEText
from email.MIMEBase import MIMEBase
from email.MIMEMultipart import MIMEMultipart
import smtplib
import mimetypes
from email.MIMEAudio import MIMEAudio 
from email.MIMEImage import MIMEImage 
from email.Encoders import encode_base64
 
def getExpiredUsers(indexfile):
    """获取所有过期的用户"""
    ca_file = open(indexfile,'rb')
    nowdays = datetime.datetime.now().strftime('%Y%m%d')
    writeindates = []
    useridlist = []
    with open(indexfile,'rb') as f:
        for eachline in ca_file:
	    linelist = eachline.split('\t')
	    overdate = '20'+linelist[1][:6]
	    username =  linelist[-1].strip().split('=')[-1]
	    # 还有三天就要过期的用户添加到需要生成证书的临时文件中
	    if int(nowdays)+3 > int(overdate):
	        useridlist.append(username)
	    else:
	        writeindates.append(eachline)
    with open('/etc/pki/CA/tmpindexfile','wb') as nf:
	nf.writelines(writeindates)
    if os.path.exists(indexfile):
        newname = indexfile + '.bk'
        if os.path.exists(newname):
            os.remove(newname)
        os.rename(indexfile,newname)
    if os.path.exists('/etc/pki/CA/tmpindexfile'):
        os.rename('/etc/pki/CA/tmpindexfile',indexfile)
    return useridlist
 
def autocreatecrt(indexfile):
    """自动创建证书"""
    userlist = getExpiredUsers(indexfile)
    if userlist:
        for username in userlist:
            if '@***.com' in username:
                user = username.split('@')[0]
                os.system('openssl genrsa 1024 > %s.key'%user)
                os.system("openssl req -new -key %s.key -out %s.csr -subj '/C=cn/ST=shanghai/O=***/OU=test/CN=%s/emailAddress=%s@***.com'"%(user,user,user,user))
                os.system('openssl ca -key *** -in %s.csr -out %s.crt -batch'%(user,user))
                os.system('openssl pkcs12 -export -clcerts -in %s.crt -inkey %s.key -out %s.pfx -passout pass:'%(user,user,user))
                autosendmail(user)
            else:
                user = username
                os.system('openssl genrsa 1024 > %s.key'%user)
                os.system("openssl req -new -key %s.key -out %s.csr -subj '/C=cn/ST=shanghai/O=***/OU=test/CN=%s/emailAddress=%s@***.com'"%(user,user,user,'****'))
                os.system('openssl ca -key *** -in %s.csr -out %s.crt -batch'%(user,user))
                os.system('openssl pkcs12 -export -clcerts -in %s.crt -inkey %s.key -out %s.pfx -passout pass:'%(user,user,user))
                autosendmail('***')
 
def autosendmail(username):
    """自动为重新生成证书的用户发送邮件,此处应该开启线程来发送邮件。
　　　　"""
    #创建一个带附件的实例
    msg = MIMEMultipart()
    server = smtplib.SMTP('smtp.***.com')
    server.login('****@***.com','****')
    try:   
        #构造附件
        crtname = username+'.pfx'
        att = MIMEText("您好，你的证书已经过期，请在三天内下载附件中的证书，并重新安装，否则过期后将无法登陆系统。",'base64', 'utf8')
        msg.attach(att)
        msg.attach(getAttachment("/etc/pki/tls/date/user/%s"%crtname))
         
        msg['to'] = username+'@***.com'
        msg['Cc'] = '****@****.com'
        msg['from'] = '****@***.com'
        msg['subject'] = Header('证书 (' + str(datetime.date.today()) + ')', \
                               'utf8')
          
        #发送邮件
        server.sendmail(msg['from'], msg['to'], \
                       msg.as_string())
    except Exception:
        att = MIMEText("发送邮件出错！！！",'base64', 'utf8')
        msg.attach(att)
        msg['to'] = '***@****.com'
        msg['Cc'] = '****@***.com'
        msg['from'] = '****@***.com'
        msg['subject'] = Header('证书 (' + str(datetime.date.today()) + ')', \
                               'utf8')
    server.close()
         
         
def getAttachment(filepath): 
    contentType, encoding = mimetypes.guess_type(filepath) 
   
    if contentType is None or encoding is not None: 
        contentType = 'application/octet-stream' 
   
    mainType, subType = contentType.split('/', 1) 
    file = open(filepath, 'rb') 
   
    if mainType == 'text': 
        attachment = MIMEText(file.read())
    elif mainType == 'image': 
        attachment = MIMEImage(file.read(),_subType=subType) 
    elif mainType == 'audio': 
        attachment = MIMEAudio(file.read(),_subType=subType) 
    else: 
        attachment = MIMEBase(mainType, subType) 
    attachment.set_payload(file.read()) 
    encode_base64(attachment) 
   
    file.close() 
   
    attachment.add_header('Content-Disposition', 'attachment',   filename=os.path.basename(filepath)) 
    return attachment 
 
if __name__ == '__main__':
    indexfile = '/etc/pki/CA/index.txt'
    autocreatecrt(indexfile)
~~~

